stages:
  - lint
  - test
  - build
  - package

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  CARGO_TERM_COLOR: always
  PACKAGE_NAME: git-igitt
  RUST_BACKTRACE: "1"

.rust_cache:
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - .cargo/
      - target/

fmt:
  stage: lint
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

clippy:
  stage: lint
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - rustup component add clippy
    - cargo clippy --all --all-targets -- --deny warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:
  stage: test
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - cargo test --all --locked
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:linux-amd64:
  stage: build
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:linux-amd64-musl:
  stage: build
  image: rust:alpine
  tags:
    - docker
  extends: .rust_cache
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:macos:
  stage: build
  tags:
    - macOS
  extends: .rust_cache
  script:
    - test -f "$HOME/.cargo/env" && source "$HOME/.cargo/env" || true
    - export PATH="$HOME/.cargo/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"
    - cargo --version
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:linux-amd64:
  stage: package
  image: alpine:latest
  tags:
    - docker
  needs:
    - job: build:linux-amd64
      artifacts: true
  script:
    - apk add --no-cache curl tar gzip
    - export VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-linux-amd64.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-linux-amd64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-linux-amd64.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:linux-amd64-musl:
  stage: package
  image: alpine:latest
  tags:
    - docker
  needs:
    - job: build:linux-amd64-musl
      artifacts: true
  script:
    - apk add --no-cache curl tar gzip
    - export VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-linux-amd64-musl.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-linux-amd64-musl.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-linux-amd64-musl.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:macos:
  stage: package
  tags:
    - macOS
  needs:
    - job: build:macos
      artifacts: true
  script:
    - export VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
    - ARCH=$(uname -m); if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
    - echo "Building packages for macOS-${ARCH}"
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-macos-${ARCH}.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-macos-${ARCH}.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-macos-${ARCH}.tar.gz"
    - mkdir -p dist/payload/usr/local/bin
    - cp target/release/${PACKAGE_NAME} dist/payload/usr/local/bin/
    - chmod 755 dist/payload/usr/local/bin/${PACKAGE_NAME}
    - |
      pkgbuild \
        --root dist/payload \
        --identifier "sx.berger.${PACKAGE_NAME}" \
        --version "${VERSION}" \
        --install-location / \
        dist/${PACKAGE_NAME}-${VERSION}-macos-${ARCH}.pkg
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-macos-${ARCH}.pkg \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-macos-${ARCH}.pkg"
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.pkg
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
