stages:
  - preflight
  - lint
  - test
  - security
  - build
  - package

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  CARGO_TERM_COLOR: always
  PACKAGE_NAME: git-igitt
  RUST_BACKTRACE: "1"

.rust_cache:
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - .cargo/
      - target/

preflight:
  stage: preflight
  image: rust:latest
  tags:
    - docker
  script:
    - 'test -f Cargo.lock || { echo "ERROR: Cargo.lock missing - commit it to the repo"; exit 1; }'
    - cargo verify-project
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

fmt:
  stage: lint
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

clippy:
  stage: lint
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - rustup component add clippy
    - cargo clippy --all --all-targets -- --deny warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:
  stage: test
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - cargo test --all --locked
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

cargo-audit:
  stage: security
  image: rust:latest
  tags:
    - docker
  script:
    - cargo install cargo-audit --locked
    - cargo audit --ignore RUSTSEC-2024-0436 --ignore RUSTSEC-2024-0320 --ignore RUSTSEC-2021-0145 --ignore RUSTSEC-2026-0008 --ignore RUSTSEC-2026-0002
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

gitleaks:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  tags:
    - docker
  script:
    - gitleaks detect --source . --verbose --redact --no-banner
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:linux-amd64:
  stage: build
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:linux-amd64-musl:
  stage: build
  image: rust:alpine
  tags:
    - docker
  extends: .rust_cache
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:macos:
  stage: build
  tags:
    - macOS
  extends: .rust_cache
  script:
    - test -f "$HOME/.cargo/env" && source "$HOME/.cargo/env" || true
    - export PATH="$HOME/.cargo/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"
    - cargo --version
    - rustup target add x86_64-apple-darwin aarch64-apple-darwin
    - cargo build --release --locked --target x86_64-apple-darwin
    - cargo build --release --locked --target aarch64-apple-darwin
    - strip target/x86_64-apple-darwin/release/${PACKAGE_NAME}
    - strip target/aarch64-apple-darwin/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/x86_64-apple-darwin/release/${PACKAGE_NAME}
      - target/aarch64-apple-darwin/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:linux-amd64:
  stage: package
  image: alpine:latest
  tags:
    - docker
  needs:
    - job: build:linux-amd64
      artifacts: true
  script:
    - apk add --no-cache curl tar gzip
    - export VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-linux-amd64.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-linux-amd64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-linux-amd64.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:linux-amd64-musl:
  stage: package
  image: alpine:latest
  tags:
    - docker
  needs:
    - job: build:linux-amd64-musl
      artifacts: true
  script:
    - apk add --no-cache curl tar gzip
    - export VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-linux-amd64-musl.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-linux-amd64-musl.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-linux-amd64-musl.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:macos:
  stage: package
  tags:
    - macOS
  needs:
    - job: build:macos
      artifacts: true
  script:
    - export VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
    - mkdir -p dist
    # Package arm64 (Apple Silicon)
    - cp target/aarch64-apple-darwin/release/${PACKAGE_NAME} dist/${PACKAGE_NAME}
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-macos-arm64.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-macos-arm64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-macos-arm64.tar.gz"
    - mkdir -p dist/payload-arm64/usr/local/bin
    - cp target/aarch64-apple-darwin/release/${PACKAGE_NAME} dist/payload-arm64/usr/local/bin/
    - chmod 755 dist/payload-arm64/usr/local/bin/${PACKAGE_NAME}
    - |
      pkgbuild \
        --root dist/payload-arm64 \
        --identifier "sx.berger.${PACKAGE_NAME}" \
        --version "${VERSION}" \
        --install-location / \
        dist/${PACKAGE_NAME}-${VERSION}-macos-arm64.pkg
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-macos-arm64.pkg \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-macos-arm64.pkg"
    # Package amd64 (Intel)
    - cp target/x86_64-apple-darwin/release/${PACKAGE_NAME} dist/${PACKAGE_NAME}
    - tar -czvf dist/${PACKAGE_NAME}-${VERSION}-macos-amd64.tar.gz -C dist ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-macos-amd64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-macos-amd64.tar.gz"
    - mkdir -p dist/payload-amd64/usr/local/bin
    - cp target/x86_64-apple-darwin/release/${PACKAGE_NAME} dist/payload-amd64/usr/local/bin/
    - chmod 755 dist/payload-amd64/usr/local/bin/${PACKAGE_NAME}
    - |
      pkgbuild \
        --root dist/payload-amd64 \
        --identifier "sx.berger.${PACKAGE_NAME}" \
        --version "${VERSION}" \
        --install-location / \
        dist/${PACKAGE_NAME}-${VERSION}-macos-amd64.pkg
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/${PACKAGE_NAME}-${VERSION}-macos-amd64.pkg \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${PACKAGE_NAME}-${VERSION}-macos-amd64.pkg"
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.pkg
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
