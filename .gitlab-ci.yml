stages:
  - lint
  - test
  - build
  - package

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  CARGO_TERM_COLOR: always
  PACKAGE_NAME: git-igitt
  RUST_BACKTRACE: "1"

.rust_cache:
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - .cargo/
      - target/

fmt:
  stage: lint
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

clippy:
  stage: lint
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - rustup component add clippy
    - cargo clippy --all --all-targets -- --deny warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

test:
  stage: test
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - cargo test --all --locked
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:linux-amd64:
  stage: build
  image: rust:latest
  tags:
    - docker
  extends: .rust_cache
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:linux-amd64-musl:
  stage: build
  image: rust:alpine
  tags:
    - docker
  extends: .rust_cache
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:macos-amd64:
  stage: build
  tags:
    - macOS
  extends: .rust_cache
  before_script:
    - source "$HOME/.cargo/env" || true
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

build:macos-arm64:
  stage: build
  tags:
    - macOS
  extends: .rust_cache
  before_script:
    - source "$HOME/.cargo/env" || true
  script:
    - cargo build --release --locked
    - strip target/release/${PACKAGE_NAME}
  artifacts:
    paths:
      - target/release/${PACKAGE_NAME}
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:linux-amd64:
  stage: package
  image: alpine:latest
  tags:
    - docker
  needs:
    - job: build:linux-amd64
      artifacts: true
  script:
    - apk add --no-cache curl tar gzip
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - cd dist && tar -czvf ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-linux-amd64.tar.gz ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-linux-amd64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_REF_SLUG}/${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-linux-amd64.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:linux-amd64-musl:
  stage: package
  image: alpine:latest
  tags:
    - docker
  needs:
    - job: build:linux-amd64-musl
      artifacts: true
  script:
    - apk add --no-cache curl tar gzip
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - cd dist && tar -czvf ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-linux-amd64-musl.tar.gz ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-linux-amd64-musl.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_REF_SLUG}/${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-linux-amd64-musl.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:macos-amd64:
  stage: package
  tags:
    - macOS
  needs:
    - job: build:macos-amd64
      artifacts: true
  script:
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - cd dist && tar -czvf ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-macos-amd64.tar.gz ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-macos-amd64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_REF_SLUG}/${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-macos-amd64.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

package:macos-arm64:
  stage: package
  tags:
    - macOS
  needs:
    - job: build:macos-arm64
      artifacts: true
  script:
    - mkdir -p dist
    - cp target/release/${PACKAGE_NAME} dist/
    - cd dist && tar -czvf ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-macos-arm64.tar.gz ${PACKAGE_NAME}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file ${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-macos-arm64.tar.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${CI_COMMIT_REF_SLUG}/${PACKAGE_NAME}-${CI_COMMIT_REF_SLUG}-macos-arm64.tar.gz"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
